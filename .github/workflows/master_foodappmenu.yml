name: CI Pipeline
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get list of changed files
        id: changed-files
        run: |
          git fetch origin
          echo "::set-output name=files::$(git diff --name-only origin/master...${{ github.sha }})"

      - name: Scan changed files
        run: |
          echo "Files changed: ${{ steps.changed-files.outputs.files }}"
          # Add your code scanning command here
          # Example: run a linter or a security scanner
          for file in ${{ steps.changed-files.outputs.files }}; do
            # replace `your-scan-command` with the actual scan command
            your-scan-command "$file"
          done

  cypress-tests:
    runs-on: ubuntu-latest
    needs: code-scan
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests
        run: npm run cypress:run

  comment-results:
    runs-on: ubuntu-latest
    needs: cypress-tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract and comment results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          response="Cypress tests completed. See the results below:"
          # Assume the response is collected in a variable or a file
          response+=$(cat cypress/results.txt) # Modify this according to your setup
          
          # Comment on the PR
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -X POST \
               -d "{\"body\": \"$response\"}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
